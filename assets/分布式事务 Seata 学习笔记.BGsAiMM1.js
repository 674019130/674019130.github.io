import{_ as g}from"./ValaxyMain.vue_vue_type_style_index_0_lang.DfSvu0AI.js";import{f as F,a as A,u as y}from"./chunks/vue-router._WMYa8cX.js";import{s as c,bH as l,aW as e,v as i,t as u,H as s,bi as C,aK as E,aM as m}from"./framework.DDojlQDl.js";import"./app.i6-hyFKY.js";import"./chunks/dayjs.DPscOGnl.js";import"./chunks/vue-i18n.D5iU1Uln.js";import"./chunks/pinia.DkkyVvQY.js";import"./chunks/@vueuse/motion.B7tSKkoB.js";import"./chunks/nprogress.DgNGesC2.js";import"./YunComment.vue_vue_type_style_index_0_lang.lVt8y9cy.js";import"./index.C5okkQwF.js";import"./YunPageHeader.vue_vue_type_script_setup_true_lang.CUTuRIHR.js";import"./post.D5cvIXgt.js";const B=F("/posts/分布式事务 Seata 学习笔记",async h=>JSON.parse('{"title":"分布式事务解决方案 Seata 学习笔记","description":"","frontmatter":{"title":"分布式事务解决方案 Seata 学习笔记","date":"2024-06-28 00:24:45","tags":["Seata","分布式事务","Java"],"postTitleClass":"text-pink-400","pageTtitleClass":"text-rgb(255, 0, 0)","categories":["技术笔记","分布式系统"],"toc":true},"headers":[{"level":2,"title":"Seata术语","slug":"seata术语","link":"#seata术语","children":[]},{"level":2,"title":"事务模式（四种）","slug":"事务模式-四种","link":"#事务模式-四种","children":[{"level":3,"title":"AT 模式 两阶段","slug":"at-模式-两阶段","link":"#at-模式-两阶段","children":[]},{"level":3,"title":"TCC 模式 两阶段","slug":"tcc-模式-两阶段","link":"#tcc-模式-两阶段","children":[]},{"level":3,"title":"Saga 模式","slug":"saga-模式","link":"#saga-模式","children":[]},{"level":3,"title":"XA 模式 两阶段","slug":"xa-模式-两阶段","link":"#xa-模式-两阶段","children":[]}]},{"level":2,"title":"TODO","slug":"todo","link":"#todo","children":[]}],"relativePath":"pages/posts/分布式事务 Seata 学习笔记.md","lastUpdated":1747386466000}'),{lazy:(h,k)=>h.name===k.name}),X={__name:"分布式事务 Seata 学习笔记",setup(h,{expose:k}){var D;const{data:r}=B(),d=y(),o=A(),n=Object.assign(o.meta.frontmatter||{},((D=r.value)==null?void 0:D.frontmatter)||{});return o.meta.frontmatter=n,d.currentRoute.value.data=r.value,m("valaxy:frontmatter",n),globalThis.$frontmatter=n,k({frontmatter:{title:"分布式事务解决方案 Seata 学习笔记",date:"2024-06-28 00:24:45",tags:["Seata","分布式事务","Java"],postTitleClass:"text-pink-400",pageTtitleClass:"text-rgb(255, 0, 0)",categories:["技术笔记","分布式系统"],toc:!0}}),(t,a)=>{const p=g;return E(),c(p,{frontmatter:C(n)},{"main-content-md":l(()=>[a[0]||(a[0]=i("p",null,[i("strong",null,"截至 2025-04-15，依然没能在项目中用上 T_T，是确实还没场景")],-1)),u(" more "),a[1]||(a[1]=i("h2",{id:"seata术语",tabindex:"-1"},[s("Seata术语 "),i("a",{class:"header-anchor",href:"#seata术语","aria-label":'Permalink to "Seata术语"'},"​")],-1)),a[2]||(a[2]=i("h4",{id:"tc-transaction-coordinator-事务协调者-控制中心-控制事务的流程",tabindex:"-1"},[s("TC (Transaction Coordinator) - 事务协调者"),i("a",{href:"https://seata.apache.org/zh-cn/docs/overview/terminology#tc-transaction-coordinator---%E4%BA%8B%E5%8A%A1%E5%8D%8F%E8%B0%83%E8%80%85",target:"_blank",rel:"noreferrer"}),s("（控制中心，控制事务的流程） "),i("a",{class:"header-anchor",href:"#tc-transaction-coordinator-事务协调者-控制中心-控制事务的流程","aria-label":'Permalink to "TC (Transaction Coordinator) - 事务协调者[](https://seata.apache.org/zh-cn/docs/overview/terminology#tc-transaction-coordinator---事务协调者)（控制中心，控制事务的流程）"'},"​")],-1)),a[3]||(a[3]=i("p",null,"维护全局和分支事务的状态，驱动全局事务提交或回滚。",-1)),a[4]||(a[4]=i("h4",{id:"tm-transaction-manager-事务管理器-用来发起事务",tabindex:"-1"},[s("TM (Transaction Manager) - 事务管理器"),i("a",{href:"https://seata.apache.org/zh-cn/docs/overview/terminology#tm-transaction-manager---%E4%BA%8B%E5%8A%A1%E7%AE%A1%E7%90%86%E5%99%A8",target:"_blank",rel:"noreferrer"}),s("（用来发起事务） "),i("a",{class:"header-anchor",href:"#tm-transaction-manager-事务管理器-用来发起事务","aria-label":'Permalink to "TM (Transaction Manager) - 事务管理器[](https://seata.apache.org/zh-cn/docs/overview/terminology#tm-transaction-manager---事务管理器)（用来发起事务）"'},"​")],-1)),a[5]||(a[5]=i("p",null,"定义全局事务的范围：开始全局事务、提交或回滚全局事务。",-1)),a[6]||(a[6]=i("h4",{id:"rm-resource-manager-资源管理器-每一个子事务实例",tabindex:"-1"},[s("RM (Resource Manager) - 资源管理器"),i("a",{href:"https://seata.apache.org/zh-cn/docs/overview/terminology#rm-resource-manager---%E8%B5%84%E6%BA%90%E7%AE%A1%E7%90%86%E5%99%A8",target:"_blank",rel:"noreferrer"}),s("（每一个子事务实例） "),i("a",{class:"header-anchor",href:"#rm-resource-manager-资源管理器-每一个子事务实例","aria-label":'Permalink to "RM (Resource Manager) - 资源管理器[](https://seata.apache.org/zh-cn/docs/overview/terminology#rm-resource-manager---资源管理器)（每一个子事务实例）"'},"​")],-1)),a[7]||(a[7]=i("p",null,"管理分支事务处理的资源，与 TC 交谈以注册分支事务和报告分支事务的状态，并驱动分支事务提交或回滚。",-1)),a[8]||(a[8]=i("h2",{id:"事务模式-四种",tabindex:"-1"},[s("事务模式（四种） "),i("a",{class:"header-anchor",href:"#事务模式-四种","aria-label":'Permalink to "事务模式（四种）"'},"​")],-1)),a[9]||(a[9]=i("h3",{id:"at-模式-两阶段",tabindex:"-1"},[s("AT 模式 两阶段 "),i("a",{class:"header-anchor",href:"#at-模式-两阶段","aria-label":'Permalink to "AT 模式 两阶段"'},"​")],-1)),a[10]||(a[10]=i("ul",null,[i("li",null,[i("p",null,[i("strong",null,"非侵入式")])]),i("li",null,[i("p",null,[i("strong",null,"两阶段"),s("提交协议")]),i("ul",null,[i("li",null,[s("一阶段：业务数据和回滚日志记录在"),i("strong",null,"同一个本地事务中提交"),s("，释放本地锁和连接资源")]),i("li",null,[s("二阶段： "),i("ul",null,[i("li",null,"提交异步化"),i("li",null,"回滚通过一阶段的回滚日志进行反向补偿")])])])]),i("li",null,[i("div",{class:"language-java vp-adaptive-theme"},[i("button",{title:"Copy Code",class:"copy"}),i("span",{class:"lang"},"java"),i("pre",{class:"shiki shiki-themes material-theme-lighter material-theme-darker vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#90A4AE","--shiki-light-font-style":"italic","--shiki-dark":"#545454","--shiki-dark-font-style":"italic"}},"// 两个数据源的情况下")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#39ADB5","--shiki-dark":"#89DDFF"}},"@"),i("span",{style:{"--shiki-light":"#9C3EDA","--shiki-dark":"#C792EA"}},"GlobalTransactional")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#9C3EDA","--shiki-dark":"#C792EA"}},"public"),i("span",{style:{"--shiki-light":"#9C3EDA","--shiki-dark":"#C792EA"}}," void"),i("span",{style:{"--shiki-light":"#6182B8","--shiki-dark":"#82AAFF"}}," purchase"),i("span",{style:{"--shiki-light":"#39ADB5","--shiki-dark":"#89DDFF"}},"("),i("span",{style:{"--shiki-light":"#9C3EDA","--shiki-dark":"#C792EA"}},"String"),i("span",{style:{"--shiki-light":"#90A4AE","--shiki-dark":"#EEFFFF"}}," userId"),i("span",{style:{"--shiki-light":"#39ADB5","--shiki-dark":"#89DDFF"}},","),i("span",{style:{"--shiki-light":"#9C3EDA","--shiki-dark":"#C792EA"}}," String"),i("span",{style:{"--shiki-light":"#90A4AE","--shiki-dark":"#EEFFFF"}}," commodityCode"),i("span",{style:{"--shiki-light":"#39ADB5","--shiki-dark":"#89DDFF"}},","),i("span",{style:{"--shiki-light":"#9C3EDA","--shiki-dark":"#C792EA"}}," int"),i("span",{style:{"--shiki-light":"#90A4AE","--shiki-dark":"#EEFFFF"}}," count"),i("span",{style:{"--shiki-light":"#39ADB5","--shiki-dark":"#89DDFF"}},","),i("span",{style:{"--shiki-light":"#9C3EDA","--shiki-dark":"#C792EA"}}," int"),i("span",{style:{"--shiki-light":"#90A4AE","--shiki-dark":"#EEFFFF"}}," money"),i("span",{style:{"--shiki-light":"#39ADB5","--shiki-dark":"#89DDFF"}},")"),i("span",{style:{"--shiki-light":"#39ADB5","--shiki-dark":"#89DDFF"}}," {")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#90A4AE","--shiki-dark":"#EEFFFF"}},"    jdbcTemplateA"),i("span",{style:{"--shiki-light":"#39ADB5","--shiki-dark":"#89DDFF"}},"."),i("span",{style:{"--shiki-light":"#6182B8","--shiki-dark":"#82AAFF"}},"update"),i("span",{style:{"--shiki-light":"#39ADB5","--shiki-dark":"#89DDFF"}},"("),i("span",{style:{"--shiki-light":"#39ADB5","--shiki-dark":"#89DDFF"}},'"'),i("span",{style:{"--shiki-light":"#91B859","--shiki-dark":"#C3E88D"}},"update stock_tbl set count = count - ? where commodity_code = ?"),i("span",{style:{"--shiki-light":"#39ADB5","--shiki-dark":"#89DDFF"}},'"'),i("span",{style:{"--shiki-light":"#39ADB5","--shiki-dark":"#89DDFF"}},","),i("span",{style:{"--shiki-light":"#39ADB5","--shiki-light-font-style":"italic","--shiki-dark":"#89DDFF","--shiki-dark-font-style":"italic"}}," new"),i("span",{style:{"--shiki-light":"#9C3EDA","--shiki-dark":"#C792EA"}}," Object"),i("span",{style:{"--shiki-light":"#39ADB5","--shiki-dark":"#89DDFF"}},"[]"),i("span",{style:{"--shiki-light":"#39ADB5","--shiki-dark":"#89DDFF"}}," {"),i("span",{style:{"--shiki-light":"#90A4AE","--shiki-dark":"#EEFFFF"}},"count"),i("span",{style:{"--shiki-light":"#39ADB5","--shiki-dark":"#89DDFF"}},","),i("span",{style:{"--shiki-light":"#90A4AE","--shiki-dark":"#EEFFFF"}}," commodityCode"),i("span",{style:{"--shiki-light":"#39ADB5","--shiki-dark":"#89DDFF"}},"});")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#90A4AE","--shiki-dark":"#EEFFFF"}},"    jdbcTemplateB"),i("span",{style:{"--shiki-light":"#39ADB5","--shiki-dark":"#89DDFF"}},"."),i("span",{style:{"--shiki-light":"#6182B8","--shiki-dark":"#82AAFF"}},"update"),i("span",{style:{"--shiki-light":"#39ADB5","--shiki-dark":"#89DDFF"}},"("),i("span",{style:{"--shiki-light":"#39ADB5","--shiki-dark":"#89DDFF"}},'"'),i("span",{style:{"--shiki-light":"#91B859","--shiki-dark":"#C3E88D"}},"update account_tbl set money = money - ? where user_id = ?"),i("span",{style:{"--shiki-light":"#39ADB5","--shiki-dark":"#89DDFF"}},'"'),i("span",{style:{"--shiki-light":"#39ADB5","--shiki-dark":"#89DDFF"}},","),i("span",{style:{"--shiki-light":"#39ADB5","--shiki-light-font-style":"italic","--shiki-dark":"#89DDFF","--shiki-dark-font-style":"italic"}}," new"),i("span",{style:{"--shiki-light":"#9C3EDA","--shiki-dark":"#C792EA"}}," Object"),i("span",{style:{"--shiki-light":"#39ADB5","--shiki-dark":"#89DDFF"}},"[]"),i("span",{style:{"--shiki-light":"#39ADB5","--shiki-dark":"#89DDFF"}}," {"),i("span",{style:{"--shiki-light":"#90A4AE","--shiki-dark":"#EEFFFF"}},"money"),i("span",{style:{"--shiki-light":"#39ADB5","--shiki-dark":"#89DDFF"}},","),i("span",{style:{"--shiki-light":"#90A4AE","--shiki-dark":"#EEFFFF"}}," userId"),i("span",{style:{"--shiki-light":"#39ADB5","--shiki-dark":"#89DDFF"}},"});")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#39ADB5","--shiki-dark":"#89DDFF"}},"}")])])]),i("button",{class:"collapse"})])]),i("li",null,[i("p",null,"（自己的理解）最简单的情况（指同一服务下多个数据源的事务操作），最好写的模式，相当于手动包装了多个数据源的事务操作，回滚也是依赖于 Seata 对于数据源的代理，相当于回滚和事务捏合这两部分 Seata 都帮你做了。"),i("p",null,"缺点也很明显，依赖于数据库原生的 SQL 和回滚操作，同时在高并发的情况下需要额外加锁。")])],-1)),a[11]||(a[11]=i("h3",{id:"tcc-模式-两阶段",tabindex:"-1"},[s("TCC 模式 两阶段 "),i("a",{class:"header-anchor",href:"#tcc-模式-两阶段","aria-label":'Permalink to "TCC 模式 两阶段"'},"​")],-1)),a[12]||(a[12]=i("ul",null,[i("li",null,"为独立部署的 SOA 服务设计，即可以做到跨应用管理"),i("li",null,[i("img",{src:"https://s2.loli.net/2024/06/28/dsezG7JymNEC2Kv.png",alt:"Overview of a global transaction",loading:"lazy",decoding:"async"})]),i("li",null,[i("strong",null,"完全不依赖数据库"),s("，是业务层面的分布式事务，AT 和 XA 都是数据库层面的分布式事务")]),i("li",null,[i("strong",null,"侵入式，自己实现 Try, Confirm, Cancel 操作（TCC 叫法的来源）"),s("，复杂 "),i("ul",null,[i("li",null,"Try 是一阶段，做资源的检查和预留"),i("li",null,[s("Confirm 是二阶段的提交，"),i("strong",null,"真正执行业务")]),i("li",null,"Cancel 是二阶段的回滚，依赖于 Try 的资源预留")])])],-1)),a[13]||(a[13]=i("blockquote",null,[i("div",{class:"language-java vp-adaptive-theme"},[i("button",{title:"Copy Code",class:"copy"}),i("span",{class:"lang"},"java"),i("pre",{class:"shiki shiki-themes material-theme-lighter material-theme-darker vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#9C3EDA","--shiki-dark":"#C792EA"}},"public"),i("span",{style:{"--shiki-light":"#9C3EDA","--shiki-dark":"#C792EA"}}," interface"),i("span",{style:{"--shiki-light":"#E2931D","--shiki-dark":"#FFCB6B"}}," TccActionOne"),i("span",{style:{"--shiki-light":"#39ADB5","--shiki-dark":"#89DDFF"}}," {")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#39ADB5","--shiki-dark":"#89DDFF"}},"    @"),i("span",{style:{"--shiki-light":"#9C3EDA","--shiki-dark":"#C792EA"}},"TwoPhaseBusinessAction"),i("span",{style:{"--shiki-light":"#39ADB5","--shiki-dark":"#89DDFF"}},"("),i("span",{style:{"--shiki-light":"#E2931D","--shiki-dark":"#FFCB6B"}},"name"),i("span",{style:{"--shiki-light":"#39ADB5","--shiki-dark":"#89DDFF"}}," ="),i("span",{style:{"--shiki-light":"#39ADB5","--shiki-dark":"#89DDFF"}},' "'),i("span",{style:{"--shiki-light":"#91B859","--shiki-dark":"#C3E88D"}},"DubboTccActionOne"),i("span",{style:{"--shiki-light":"#39ADB5","--shiki-dark":"#89DDFF"}},'"'),i("span",{style:{"--shiki-light":"#39ADB5","--shiki-dark":"#89DDFF"}},","),i("span",{style:{"--shiki-light":"#E2931D","--shiki-dark":"#FFCB6B"}}," commitMethod"),i("span",{style:{"--shiki-light":"#39ADB5","--shiki-dark":"#89DDFF"}}," ="),i("span",{style:{"--shiki-light":"#39ADB5","--shiki-dark":"#89DDFF"}},' "'),i("span",{style:{"--shiki-light":"#91B859","--shiki-dark":"#C3E88D"}},"commit"),i("span",{style:{"--shiki-light":"#39ADB5","--shiki-dark":"#89DDFF"}},'"'),i("span",{style:{"--shiki-light":"#39ADB5","--shiki-dark":"#89DDFF"}},","),i("span",{style:{"--shiki-light":"#E2931D","--shiki-dark":"#FFCB6B"}}," rollbackMethod"),i("span",{style:{"--shiki-light":"#39ADB5","--shiki-dark":"#89DDFF"}}," ="),i("span",{style:{"--shiki-light":"#39ADB5","--shiki-dark":"#89DDFF"}},' "'),i("span",{style:{"--shiki-light":"#91B859","--shiki-dark":"#C3E88D"}},"rollback"),i("span",{style:{"--shiki-light":"#39ADB5","--shiki-dark":"#89DDFF"}},'"'),i("span",{style:{"--shiki-light":"#39ADB5","--shiki-dark":"#89DDFF"}},")")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#9C3EDA","--shiki-dark":"#C792EA"}},"    public"),i("span",{style:{"--shiki-light":"#9C3EDA","--shiki-dark":"#C792EA"}}," boolean"),i("span",{style:{"--shiki-light":"#6182B8","--shiki-dark":"#82AAFF"}}," prepare"),i("span",{style:{"--shiki-light":"#39ADB5","--shiki-dark":"#89DDFF"}},"("),i("span",{style:{"--shiki-light":"#9C3EDA","--shiki-dark":"#C792EA"}},"BusinessActionContext"),i("span",{style:{"--shiki-light":"#90A4AE","--shiki-light-font-style":"italic","--shiki-dark":"#EEFFFF","--shiki-dark-font-style":"italic"}}," actionContext"),i("span",{style:{"--shiki-light":"#39ADB5","--shiki-dark":"#89DDFF"}},","),i("span",{style:{"--shiki-light":"#39ADB5","--shiki-dark":"#89DDFF"}}," @"),i("span",{style:{"--shiki-light":"#9C3EDA","--shiki-dark":"#C792EA"}},"BusinessActionContextParameter"),i("span",{style:{"--shiki-light":"#39ADB5","--shiki-dark":"#89DDFF"}},"("),i("span",{style:{"--shiki-light":"#E2931D","--shiki-dark":"#FFCB6B"}},"paramName"),i("span",{style:{"--shiki-light":"#39ADB5","--shiki-dark":"#89DDFF"}}," ="),i("span",{style:{"--shiki-light":"#39ADB5","--shiki-dark":"#89DDFF"}},' "'),i("span",{style:{"--shiki-light":"#91B859","--shiki-dark":"#C3E88D"}},"a"),i("span",{style:{"--shiki-light":"#39ADB5","--shiki-dark":"#89DDFF"}},'"'),i("span",{style:{"--shiki-light":"#39ADB5","--shiki-dark":"#89DDFF"}},")"),i("span",{style:{"--shiki-light":"#9C3EDA","--shiki-dark":"#C792EA"}}," String"),i("span",{style:{"--shiki-light":"#90A4AE","--shiki-light-font-style":"italic","--shiki-dark":"#EEFFFF","--shiki-dark-font-style":"italic"}}," a"),i("span",{style:{"--shiki-light":"#39ADB5","--shiki-dark":"#89DDFF"}},");")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#9C3EDA","--shiki-dark":"#C792EA"}},"    public"),i("span",{style:{"--shiki-light":"#9C3EDA","--shiki-dark":"#C792EA"}}," boolean"),i("span",{style:{"--shiki-light":"#6182B8","--shiki-dark":"#82AAFF"}}," commit"),i("span",{style:{"--shiki-light":"#39ADB5","--shiki-dark":"#89DDFF"}},"("),i("span",{style:{"--shiki-light":"#9C3EDA","--shiki-dark":"#C792EA"}},"BusinessActionContext"),i("span",{style:{"--shiki-light":"#90A4AE","--shiki-light-font-style":"italic","--shiki-dark":"#EEFFFF","--shiki-dark-font-style":"italic"}}," actionContext"),i("span",{style:{"--shiki-light":"#39ADB5","--shiki-dark":"#89DDFF"}},");")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#9C3EDA","--shiki-dark":"#C792EA"}},"    public"),i("span",{style:{"--shiki-light":"#9C3EDA","--shiki-dark":"#C792EA"}}," boolean"),i("span",{style:{"--shiki-light":"#6182B8","--shiki-dark":"#82AAFF"}}," rollback"),i("span",{style:{"--shiki-light":"#39ADB5","--shiki-dark":"#89DDFF"}},"("),i("span",{style:{"--shiki-light":"#9C3EDA","--shiki-dark":"#C792EA"}},"BusinessActionContext"),i("span",{style:{"--shiki-light":"#90A4AE","--shiki-light-font-style":"italic","--shiki-dark":"#EEFFFF","--shiki-dark-font-style":"italic"}}," actionContext"),i("span",{style:{"--shiki-light":"#39ADB5","--shiki-dark":"#89DDFF"}},");")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#39ADB5","--shiki-dark":"#89DDFF"}},"}")])])]),i("button",{class:"collapse"})]),i("p",null,[s("Seata 会把一个 TCC 接口当成一个 Resource，也叫 TCC Resource。"),i("strong",null,[s("在业务接口中核心的注解是 "),i("code",null,"@TwoPhaseBusinessAction"),s("，表示当前方法使用 TCC 模式管理事务提交")]),s("，并标明了 Try，Confirm，Cancel 三个阶段。name属性，给当前事务注册了一个全局唯一的的 TCC bean name。同时 TCC 模式的三个执行阶段分别是：")]),i("ul",null,[i("li",null,[s("Try 阶段，预定操作资源（Prepare） 这一阶段所以执行的方法便是"),i("strong",null,[s("被 "),i("code",null,"@TwoPhaseBusinessAction"),s(" 所修饰的方法")]),s("。如示例代码中的 "),i("code",null,"prepare"),s(" 方法。")]),i("li",null,[s("Confirm 阶段，执行主要业务逻辑（Commit） 这一阶段使用 "),i("strong",null,[i("code",null,"commitMethod"),s(" 属性所指向的方法")]),s("，来执行 "),i("strong",null,"Confirm"),s(" 的工作。")]),i("li",null,[s("Cancel 阶段，事务回滚（Rollback） 这一阶段"),i("strong",null,[s("使用 "),i("code",null,"rollbackMethod"),s(" 属性所指向的方法")]),s("，来执行 "),i("strong",null,"Cancel"),s(" 的工作。")])]),i("hr"),i("p",null,[s("其次，可以在 TCC 模式下"),i("strong",null,[s("使用 "),i("code",null,"BusinessActionContext"),s(" 在事务上下文中传递查询参数")]),s("。如下属性：")]),i("ul",null,[i("li",null,[i("code",null,"xid"),s(" 全局事务id")]),i("li",null,[i("code",null,"branchId"),s(" 分支事务id")]),i("li",null,[i("code",null,"actionName"),s(" 分支资源id，（resource id）")]),i("li",null,[i("code",null,"actionContext"),s(" 业务传递的参数，可以通过 "),i("code",null,"@BusinessActionContextParameter"),s(" 来标注需要传递的参数。")])]),i("p",null,[s("在定义好 TCC 接口之后，我们可以像 AT 模式一样，通过 "),i("code",null,"@GlobalTransactional"),s(" 开启一个分布式事务。")]),i("div",{class:"language-java vp-adaptive-theme"},[i("button",{title:"Copy Code",class:"copy"}),i("span",{class:"lang"},"java"),i("pre",{class:"shiki shiki-themes material-theme-lighter material-theme-darker vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#39ADB5","--shiki-dark":"#89DDFF"}},"@"),i("span",{style:{"--shiki-light":"#9C3EDA","--shiki-dark":"#C792EA"}},"GlobalTransactional")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#9C3EDA","--shiki-dark":"#C792EA"}},"public"),i("span",{style:{"--shiki-light":"#9C3EDA","--shiki-dark":"#C792EA"}}," String"),i("span",{style:{"--shiki-light":"#6182B8","--shiki-dark":"#82AAFF"}}," doTransactionCommit"),i("span",{style:{"--shiki-light":"#39ADB5","--shiki-dark":"#89DDFF"}},"(){")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#90A4AE","--shiki-dark":"#EEFFFF"}},"    tccActionOne"),i("span",{style:{"--shiki-light":"#39ADB5","--shiki-dark":"#89DDFF"}},"."),i("span",{style:{"--shiki-light":"#6182B8","--shiki-dark":"#82AAFF"}},"prepare"),i("span",{style:{"--shiki-light":"#39ADB5","--shiki-dark":"#89DDFF"}},"(null,"),i("span",{style:{"--shiki-light":"#39ADB5","--shiki-dark":"#89DDFF"}},'"'),i("span",{style:{"--shiki-light":"#91B859","--shiki-dark":"#C3E88D"}},"one"),i("span",{style:{"--shiki-light":"#39ADB5","--shiki-dark":"#89DDFF"}},'"'),i("span",{style:{"--shiki-light":"#39ADB5","--shiki-dark":"#89DDFF"}},");")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#90A4AE","--shiki-dark":"#EEFFFF"}},"    tccActionTwo"),i("span",{style:{"--shiki-light":"#39ADB5","--shiki-dark":"#89DDFF"}},"."),i("span",{style:{"--shiki-light":"#6182B8","--shiki-dark":"#82AAFF"}},"prepare"),i("span",{style:{"--shiki-light":"#39ADB5","--shiki-dark":"#89DDFF"}},"(null,"),i("span",{style:{"--shiki-light":"#39ADB5","--shiki-dark":"#89DDFF"}},'"'),i("span",{style:{"--shiki-light":"#91B859","--shiki-dark":"#C3E88D"}},"two"),i("span",{style:{"--shiki-light":"#39ADB5","--shiki-dark":"#89DDFF"}},'"'),i("span",{style:{"--shiki-light":"#39ADB5","--shiki-dark":"#89DDFF"}},");")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#39ADB5","--shiki-dark":"#89DDFF"}},"}")])])]),i("button",{class:"collapse"})]),i("p",null,"注意，如果 TCC 参与者是本地 bean（非远程RPC服务），本地 TCC bean 还需要在接口定义中添加 @LocalTCC 注解，比如,"),i("div",{class:"language-java vp-adaptive-theme"},[i("button",{title:"Copy Code",class:"copy"}),i("span",{class:"lang"},"java"),i("pre",{class:"shiki shiki-themes material-theme-lighter material-theme-darker vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#39ADB5","--shiki-dark":"#89DDFF"}},"@"),i("span",{style:{"--shiki-light":"#9C3EDA","--shiki-dark":"#C792EA"}},"LocalTCC")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#9C3EDA","--shiki-dark":"#C792EA"}},"public"),i("span",{style:{"--shiki-light":"#9C3EDA","--shiki-dark":"#C792EA"}}," interface"),i("span",{style:{"--shiki-light":"#E2931D","--shiki-dark":"#FFCB6B"}}," TccActionTwo"),i("span",{style:{"--shiki-light":"#39ADB5","--shiki-dark":"#89DDFF"}}," {")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#39ADB5","--shiki-dark":"#89DDFF"}},"    @"),i("span",{style:{"--shiki-light":"#9C3EDA","--shiki-dark":"#C792EA"}},"TwoPhaseBusinessAction"),i("span",{style:{"--shiki-light":"#39ADB5","--shiki-dark":"#89DDFF"}},"("),i("span",{style:{"--shiki-light":"#E2931D","--shiki-dark":"#FFCB6B"}},"name"),i("span",{style:{"--shiki-light":"#39ADB5","--shiki-dark":"#89DDFF"}}," ="),i("span",{style:{"--shiki-light":"#39ADB5","--shiki-dark":"#89DDFF"}},' "'),i("span",{style:{"--shiki-light":"#91B859","--shiki-dark":"#C3E88D"}},"TccActionTwo"),i("span",{style:{"--shiki-light":"#39ADB5","--shiki-dark":"#89DDFF"}},'"'),i("span",{style:{"--shiki-light":"#39ADB5","--shiki-dark":"#89DDFF"}},","),i("span",{style:{"--shiki-light":"#E2931D","--shiki-dark":"#FFCB6B"}}," commitMethod"),i("span",{style:{"--shiki-light":"#39ADB5","--shiki-dark":"#89DDFF"}}," ="),i("span",{style:{"--shiki-light":"#39ADB5","--shiki-dark":"#89DDFF"}},' "'),i("span",{style:{"--shiki-light":"#91B859","--shiki-dark":"#C3E88D"}},"commit"),i("span",{style:{"--shiki-light":"#39ADB5","--shiki-dark":"#89DDFF"}},'"'),i("span",{style:{"--shiki-light":"#39ADB5","--shiki-dark":"#89DDFF"}},","),i("span",{style:{"--shiki-light":"#E2931D","--shiki-dark":"#FFCB6B"}}," rollbackMethod"),i("span",{style:{"--shiki-light":"#39ADB5","--shiki-dark":"#89DDFF"}}," ="),i("span",{style:{"--shiki-light":"#39ADB5","--shiki-dark":"#89DDFF"}},' "'),i("span",{style:{"--shiki-light":"#91B859","--shiki-dark":"#C3E88D"}},"rollback"),i("span",{style:{"--shiki-light":"#39ADB5","--shiki-dark":"#89DDFF"}},'"'),i("span",{style:{"--shiki-light":"#39ADB5","--shiki-dark":"#89DDFF"}},")")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#9C3EDA","--shiki-dark":"#C792EA"}},"    public"),i("span",{style:{"--shiki-light":"#9C3EDA","--shiki-dark":"#C792EA"}}," boolean"),i("span",{style:{"--shiki-light":"#6182B8","--shiki-dark":"#82AAFF"}}," prepare"),i("span",{style:{"--shiki-light":"#39ADB5","--shiki-dark":"#89DDFF"}},"("),i("span",{style:{"--shiki-light":"#9C3EDA","--shiki-dark":"#C792EA"}},"BusinessActionContext"),i("span",{style:{"--shiki-light":"#90A4AE","--shiki-light-font-style":"italic","--shiki-dark":"#EEFFFF","--shiki-dark-font-style":"italic"}}," actionContext"),i("span",{style:{"--shiki-light":"#39ADB5","--shiki-dark":"#89DDFF"}},","),i("span",{style:{"--shiki-light":"#39ADB5","--shiki-dark":"#89DDFF"}}," @"),i("span",{style:{"--shiki-light":"#9C3EDA","--shiki-dark":"#C792EA"}},"BusinessActionContextParameter"),i("span",{style:{"--shiki-light":"#39ADB5","--shiki-dark":"#89DDFF"}},"("),i("span",{style:{"--shiki-light":"#E2931D","--shiki-dark":"#FFCB6B"}},"paramName"),i("span",{style:{"--shiki-light":"#39ADB5","--shiki-dark":"#89DDFF"}}," ="),i("span",{style:{"--shiki-light":"#39ADB5","--shiki-dark":"#89DDFF"}},' "'),i("span",{style:{"--shiki-light":"#91B859","--shiki-dark":"#C3E88D"}},"a"),i("span",{style:{"--shiki-light":"#39ADB5","--shiki-dark":"#89DDFF"}},'"'),i("span",{style:{"--shiki-light":"#39ADB5","--shiki-dark":"#89DDFF"}},")"),i("span",{style:{"--shiki-light":"#9C3EDA","--shiki-dark":"#C792EA"}}," String"),i("span",{style:{"--shiki-light":"#90A4AE","--shiki-light-font-style":"italic","--shiki-dark":"#EEFFFF","--shiki-dark-font-style":"italic"}}," a"),i("span",{style:{"--shiki-light":"#39ADB5","--shiki-dark":"#89DDFF"}},");")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#9C3EDA","--shiki-dark":"#C792EA"}},"    public"),i("span",{style:{"--shiki-light":"#9C3EDA","--shiki-dark":"#C792EA"}}," boolean"),i("span",{style:{"--shiki-light":"#6182B8","--shiki-dark":"#82AAFF"}}," commit"),i("span",{style:{"--shiki-light":"#39ADB5","--shiki-dark":"#89DDFF"}},"("),i("span",{style:{"--shiki-light":"#9C3EDA","--shiki-dark":"#C792EA"}},"BusinessActionContext"),i("span",{style:{"--shiki-light":"#90A4AE","--shiki-light-font-style":"italic","--shiki-dark":"#EEFFFF","--shiki-dark-font-style":"italic"}}," actionContext"),i("span",{style:{"--shiki-light":"#39ADB5","--shiki-dark":"#89DDFF"}},");")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#9C3EDA","--shiki-dark":"#C792EA"}},"    public"),i("span",{style:{"--shiki-light":"#9C3EDA","--shiki-dark":"#C792EA"}}," boolean"),i("span",{style:{"--shiki-light":"#6182B8","--shiki-dark":"#82AAFF"}}," rollback"),i("span",{style:{"--shiki-light":"#39ADB5","--shiki-dark":"#89DDFF"}},"("),i("span",{style:{"--shiki-light":"#9C3EDA","--shiki-dark":"#C792EA"}},"BusinessActionContext"),i("span",{style:{"--shiki-light":"#90A4AE","--shiki-light-font-style":"italic","--shiki-dark":"#EEFFFF","--shiki-dark-font-style":"italic"}}," actionContext"),i("span",{style:{"--shiki-light":"#39ADB5","--shiki-dark":"#89DDFF"}},");")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#39ADB5","--shiki-dark":"#89DDFF"}},"}")])])]),i("button",{class:"collapse"})])],-1)),a[14]||(a[14]=i("p",null,[s("相**当于是自己实现一个 AT 模式，入口放开了，要做的填充也就多了。**比如需要自己从业务层面实现隔离性（比如添加 "),i("code",null,"冻结余额"),s(" 字段）")],-1)),a[15]||(a[15]=i("p",null,[i("strong",null,"但是本质是不同的，AT 模式依赖于数据库，TCC 模式只依赖于自己写的业务代码"),s("，理论上来说我对 Redis 也可以使用 TCC 来完成一次分布式事务。")],-1)),a[16]||(a[16]=i("h3",{id:"saga-模式",tabindex:"-1"},[s("Saga 模式 "),i("a",{class:"header-anchor",href:"#saga-模式","aria-label":'Permalink to "Saga 模式"'},"​")],-1)),a[17]||(a[17]=i("ul",null,[i("li",null,[s("用于 "),i("strong",null,"参与者比较多，长事务"),s(" 场景")]),i("li",null,"因为一些原因无法实现 TCC 三个接口的时候"),i("li",null,[s("自己理解的流程大概就是每一个事务都各干各的，"),i("strong",null,"异步执行"),s("，有点 "),i("strong",null,"乐观锁"),s(" 的意思；只有在出现问题的时候，才对之前已经执行了的事务做回滚（补偿）。")])],-1)),a[18]||(a[18]=i("p",null,[s("​ 但是 Saga 模式 "),i("strong",null,"不保证隔离性"),s("，也就是事务与事务之间可能会相互影响，在做回滚时可能会失败，因为别的事务也执行了。有点 "),i("strong",null,"AP 和 CP 的区别"),s(" 的意思。")],-1)),a[19]||(a[19]=i("p",null,"​ 关于隔离性的应对方案，要结合业务来说，总之是尽量保证亏损可接受，解决方案可落地，不能做到最后用户确实没钱了，想回滚只能逼用户去犯罪（bushi",-1)),a[20]||(a[20]=i("ul",null,[i("li",null,[i("img",{src:"https://s2.loli.net/2024/06/28/1POJBCnmizGwb6r.png",alt:"Saga模式示意图",loading:"lazy",decoding:"async"})]),i("li",null,[s("Seata Saga 提供了一个"),i("strong",null,"可视化的状态机设计器"),s(),i("a",{href:"https://github.com/apache/incubator-seata/tree/refactor_designer/saga/seata-saga-statemachine-designer",target:"_blank",rel:"noreferrer"},"https://github.com/apache/incubator-seata/tree/refactor_designer/saga/seata-saga-statemachine-designer")])],-1)),a[21]||(a[21]=i("h3",{id:"xa-模式-两阶段",tabindex:"-1"},[s("XA 模式 两阶段 "),i("a",{class:"header-anchor",href:"#xa-模式-两阶段","aria-label":'Permalink to "XA 模式 两阶段"'},"​")],-1)),a[22]||(a[22]=i("ul",null,[i("li",null,[i("p",null,[s("我说实话，除了 "),i("strong",null,"是基于被主流数据库都实现了的 XA 协议"),s(" 这一点，没看出来跟 AT 模式有什么区别。")])]),i("li",null,[i("p",null,[i("strong",null,"数据库那边做了隔离"),s("，所以能满足全局的数据一致性")])]),i("li",null,[i("p",null,"会阻塞，性能差"),i("blockquote",null,[i("p",null,"XA prepare 后，分支事务进入阻塞阶段，收到 XA commit 或 XA rollback 前必须阻塞等待。事务资源长时间得不到释放，锁定周期长，而且在应用层上面无法干预，性能差。")]),i("p",null,"然后我去问了下 ChatGPT，XA 模式是同步的，所有 RM 都准备完成后才能提交或者回滚；AT模式是支持异步提交的，阻塞肯定比 XA 是好很多的。")])],-1)),a[23]||(a[23]=i("h2",{id:"todo",tabindex:"-1"},[s("TODO "),i("a",{class:"header-anchor",href:"#todo","aria-label":'Permalink to "TODO"'},"​")],-1)),a[24]||(a[24]=i("ul",null,[i("li",null,"了解全局锁本地锁跟数据隔离是怎么互相作用的"),i("li",null,"真正用到的时候了解一下写法，写 DEMO 验证"),i("li",null,"了解三阶段提交")],-1))]),"main-header":l(()=>[e(t.$slots,"main-header")]),"main-header-after":l(()=>[e(t.$slots,"main-header-after")]),"main-nav":l(()=>[e(t.$slots,"main-nav")]),"main-content-before":l(()=>[e(t.$slots,"main-content-before")]),"main-content":l(()=>[e(t.$slots,"main-content")]),"main-content-after":l(()=>[e(t.$slots,"main-content-after")]),"main-nav-before":l(()=>[e(t.$slots,"main-nav-before")]),"main-nav-after":l(()=>[e(t.$slots,"main-nav-after")]),comment:l(()=>[e(t.$slots,"comment")]),footer:l(()=>[e(t.$slots,"footer")]),aside:l(()=>[e(t.$slots,"aside")]),"aside-custom":l(()=>[e(t.$slots,"aside-custom")]),default:l(()=>[e(t.$slots,"default")]),_:3},8,["frontmatter"])}}};export{X as default,B as usePageData};
